#!/bin/bash

set -eo pipefail

# Directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Initialize conda so "conda activate" works non-interactively
eval "$(conda shell.bash hook)"

# Function to run commands quietly, only showing output on error
# Usage: run_quiet "description" command arg1 arg2 ...
run_quiet() {
    local description="$1"
    shift

    echo -n "â³ $description... "

    # Capture output in variable
    local output
    if output=$("$@" 2>&1); then
        echo "âœ“"
        return 0
    else
        local exit_code=$?
        echo "âœ— (exit code: $exit_code)"
        echo ""
        echo "Command failed: $*"
        echo "$output"
        return $exit_code
    fi
}

echo "==============================="
echo "ğŸ¼ Installing Bamboo Controller "
echo "==============================="

echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ‘¥ User Groups"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Checking required user groups..."
echo "  â€¢ realtime: Required for real-time kernel operations and robot control"
echo "  â€¢ dialout:  Required for serial communication with Robotiq gripper"
echo "  â€¢ tty:      Required for serial communication with Robotiq gripper"
echo ""

# Check which groups the user is in
current_groups=$(groups "$USER")
missing_groups=()
NEEDS_LOGOUT=false

for group in realtime dialout tty; do
    if echo "$current_groups" | grep -qw "$group"; then
        echo "âœ“ User '$USER' is in group '$group'"
    else
        echo "âœ— User '$USER' is NOT in group '$group'"
        missing_groups+=("$group")
    fi
done

if [ ${#missing_groups[@]} -gt 0 ]; then
    echo ""
    echo "The following groups need to be added for user '$USER':"
    printf '  - %s\n' "${missing_groups[@]}"
    echo ""
    echo "Will run the following command(s) (sudo password will be requested):"
    for group in "${missing_groups[@]}"; do
        echo "  sudo usermod -a -G $group $USER"
    done
    echo ""
    for group in "${missing_groups[@]}"; do
        sudo usermod -a -G "$group" "$USER"
        echo "âœ“ Added '$USER' to group '$group'"
    done
    NEEDS_LOGOUT=true
else
    echo "âœ“ User is already in all required groups"
fi

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ“¦ System Dependencies"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
packages=(libzmq3-dev libmsgpack-dev libpoco-dev)
missing_packages=()

for pkg in "${packages[@]}"; do
    if ! dpkg -s "$pkg" &> /dev/null; then
        echo "âœ— $pkg is not installed"
        missing_packages+=("$pkg")
    else
        echo "âœ“ $pkg is already installed"
    fi
done

if [ ${#missing_packages[@]} -gt 0 ]; then
    echo ""
    echo "The following packages need to be installed:"
    printf '  - %s\n' "${missing_packages[@]}"
    echo ""
    echo "Will run the following command (sudo password will be requested and you will need to confirm):"
    echo "  sudo apt-get install ${missing_packages[*]}"
    echo ""
    sudo apt-get install "${missing_packages[@]}"
    echo "âœ“ All packages installed successfully"
else
    echo "âœ“ All required packages are already installed"
fi

# Now we need to build libfranka
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ”¨ Cloning and Building libfranka"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
cd "$SCRIPT_DIR"
mkdir -p third_party
cd third_party

# Check if we need to clone
should_clone=true
if [ -d "libfranka" ]; then
    echo "libfranka directory exists, checking integrity..."

    # Check if valid git repo with good integrity
    if cd libfranka 2>/dev/null && \
       git fsck --full >/dev/null 2>&1; then
        echo "âœ“ libfranka repository is intact, skipping clone"
        should_clone=false
        cd ..
    else
        echo "âœ— libfranka repository is corrupted, removing..."
        cd ..
        rm -rf libfranka
    fi
fi

if [ "$should_clone" = true ]; then
    run_quiet "libfranka: git clone" git clone --recurse-submodules https://github.com/frankaemika/libfranka
fi

# Ask for version
echo "This script builds libfranka locally and will not override any system installs."
echo
echo "Which libfranka version would you like to use? (e.g., 0.14.0, 0.13.0, 0.9.0)"
echo
echo "Please do not use the latest version unless you have checked compatibility."
echo "libfranka must match your robot firmware:"
echo "  https://frankarobotics.github.io/docs/libfranka/docs/compatibility_with_images.html"
echo
echo "If you want to check what you already have in other projects, run:"
echo "  locate libfranka.so"
echo
read -rp "Enter libfranka version: " version

# Check if Pinocchio is required (libfranka >= 0.14.0)
# Parse version string to compare
version_major=$(echo "$version" | cut -d. -f1)
version_minor=$(echo "$version" | cut -d. -f2)

if [ "$version_major" -eq 0 ] && [ "$version_minor" -ge 14 ]; then
    echo ""
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "ğŸ“¦ Checking Pinocchio"
    echo "(required for libfranka >= 0.14.0)"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    # Check if pinocchio is installed via pkg-config
    pinocchio_found=false
    if pkg-config --exists pinocchio 2>/dev/null; then
        pinocchio_version=$(pkg-config --modversion pinocchio)
        echo "âœ“ Pinocchio $pinocchio_version found via pkg-config"
        pinocchio_found=true
    elif [ -d "/opt/openrobots/lib/cmake/pinocchio" ]; then
        echo "âœ“ Pinocchio found in /opt/openrobots"
        pinocchio_found=true
    fi

    if [ "$pinocchio_found" = false ]; then
        echo "âœ— Pinocchio is NOT installed"
        echo ""
        echo "ERROR: libfranka $version requires Pinocchio to be installed."
        echo ""
        echo "Please follow the installation instructions at:"
        echo "  https://github.com/frankarobotics/libfranka/tree/release-0.15.2?tab=readme-ov-file#2-installing-dependencies"
        echo ""
        echo "After installing Pinocchio, run this script again."
        exit 1
    fi
fi

# Checkout version and build it (doesn't hurt to build it again even if already built)
cd libfranka
run_quiet "libfranka: git checkout ${version}" git checkout "${version}"
run_quiet "libfranka: git submodule update" git submodule update

mkdir -p build
cd build
run_quiet "libfranka: cmake configure" cmake .. -DCMAKE_INSTALL_PREFIX="$SCRIPT_DIR/install" -DBUILD_TESTS=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=/opt/openrobots/lib/cmake
run_quiet "libfranka: build" make -j"$(nproc)"
run_quiet "libfranka: install" make install
echo "âœ“ libfranka installation complete!"
echo "Installation directory: $SCRIPT_DIR/install"

# Now we install bamboo!
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ”¨ Building Bamboo Controller"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
# Check if conda is available
if ! command -v conda &> /dev/null; then
    echo "âœ— Error: conda is not installed or not in PATH"
    exit 1
fi

# Python environment required for gripper control
env_name="bamboo"

# Loop until we have a valid environment (existing and confirmed, or new)
while true; do
    if conda env list | grep -qE "^${env_name}\s"; then
        echo "Conda environment '$env_name' already exists."

        # Keep asking until we get y or n
        while true; do
            read -rp "Do you want to use this environment? (y/n): " use_existing
            if [[ "$use_existing" =~ ^[Yy]$ ]]; then
                echo "âœ“ Using existing environment '$env_name'"
                break 2  # Break out of both loops
            elif [[ "$use_existing" =~ ^[Nn]$ ]]; then
                while true; do
                    read -rp "Enter a different environment name: " env_name
                    if [ -z "$env_name" ]; then
                        echo "Error: Environment name cannot be empty. Please try again."
                    else
                        break
                    fi
                done
                break  # Break inner loop to check if new name exists
            else
                echo "Please enter 'y' or 'n'"
            fi
        done
    else
        if [ -z "$env_name" ]; then
            echo "Error: Environment name cannot be empty."
            read -rp "Enter a valid environment name: " env_name
            continue
        fi
        echo "Creating conda environment '$env_name'..."
        conda create -n "$env_name" python=3.10 -y
        echo "âœ“ Conda environment '$env_name' created"
        break
    fi
done

# Now activate environment and install Bamboo with server dependencies
conda activate "$env_name"
run_quiet "bamboo: installing Python package with server dependencies" pip install -e "$SCRIPT_DIR[server]"

# Deal with the C++ build
BUILD_DIR="$SCRIPT_DIR/controller/build"
if [ ! -d "$BUILD_DIR" ]; then
    echo "Creating build directory: $BUILD_DIR"
    mkdir -p "$BUILD_DIR"
fi

cd "$BUILD_DIR"
run_quiet "bamboo: cmake configure" cmake ..
run_quiet "bamboo: build" make -j"$(nproc)"

echo ""
echo "ğŸ‰ Bamboo Controller installation complete!"
echo ""

if [ "$NEEDS_LOGOUT" = true ]; then
    echo "âš ï¸  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âš ï¸  IMPORTANT: You were added to new user groups during installation."
    echo "âš ï¸  "
    echo "âš ï¸  You MUST log out and log back in before running the controller!"
    echo "âš ï¸  "
    echo "âš ï¸  The group changes (realtime, dialout, tty) will not take effect"
    echo "âš ï¸  until you start a new session."
    echo "âš ï¸  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
fi
