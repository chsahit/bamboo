#!/bin/bash

# Fail on errors and pipeline failures
set -eo pipefail


# Get directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Initialize conda so "conda activate" works non-interactively
eval "$(conda shell.bash hook)"

ENV_NAME="bamboo"

echo "=== Checking conda environment '$ENV_NAME' ==="
if conda env list | grep -qE "^${ENV_NAME}\s"; then
    echo "Environment '$ENV_NAME' already exists. Skipping creation."
else
    echo "Creating environment '$ENV_NAME'..."
    conda create -n "$ENV_NAME" python=3.10 -y
fi

echo "=== Activating environment '$ENV_NAME' ==="
conda activate "$ENV_NAME"

echo "=== Installing bamboo package ==="
pip install -e "$SCRIPT_DIR"

# Build directory (inside bamboo/)
BAMBOO_DIR="$SCRIPT_DIR/bamboo"
BUILD_DIR="$BAMBOO_DIR/build"

echo "=== Preparing build directory ==="
if [ ! -d "$BUILD_DIR" ]; then
    echo "Creating build directory: $BUILD_DIR"
    mkdir -p "$BUILD_DIR"
else
    echo "Build directory already exists. Reusing it."
fi

echo "=== Running CMake ==="
cd "$BUILD_DIR"
cmake .. 

echo "=== Building with make ==="
make -j"$(nproc)"

echo "=== Done. Build successful. ==="
