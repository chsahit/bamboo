#!/bin/bash
#set -e

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Helper function to run build commands quietly
# Shows only errors unless the command fails
run_quiet() {
    local step_name="$1"
    shift
    local log_file=$(mktemp)

    echo "[$step_name]..."
    if "$@" > "$log_file" 2>&1; then
        echo "[$step_name] ✓"
        rm "$log_file"
        return 0
    else
        echo "[$step_name] ✗ FAILED - Output:"
        echo "----------------------------------------"
        cat "$log_file"
        echo "----------------------------------------"
        rm "$log_file"
        return 1
    fi
}

# Find best cmake (requires 3.16+)
# Priority: local installation in ~/local/src/cmake-*/bin/cmake, then system cmake
CMAKE_CMD="cmake"
if [ -d "$HOME/local/src" ]; then
    # Find any local cmake installation
    LOCAL_CMAKE=$(find "$HOME/local/src" -path "*/cmake-*/bin/cmake" -type f 2>/dev/null | head -1)
    if [ -n "$LOCAL_CMAKE" ] && [ -x "$LOCAL_CMAKE" ]; then
        CMAKE_CMD="$LOCAL_CMAKE"
        echo "Using local cmake: $CMAKE_CMD ($($CMAKE_CMD --version | head -1))"
    fi
fi

# If still using system cmake, check version
if [ "$CMAKE_CMD" = "cmake" ]; then
    CMAKE_VERSION=$(cmake --version 2>/dev/null | head -1 | grep -oP '\d+\.\d+\.\d+' || echo "0.0.0")
    echo "Using system cmake: version $CMAKE_VERSION"
    # Note: This script requires cmake 3.16+ for protobuf v27.0 and gRPC v1.64.0
fi

# Clone libfranka to third_party
cd "$SCRIPT_DIR"
mkdir -p third_party
cd third_party
run_quiet "libfranka: git clone" git clone --recurse-submodules https://github.com/frankaemika/libfranka
cd libfranka

echo "Which libfranka version are you going to use? (tested on 0.14.0, but 0.13.0 should work as well)"
read version

run_quiet "libfranka: git checkout ${version}" git checkout ${version}
run_quiet "libfranka: git submodule update" git submodule update

mkdir -p build
cd build

# Install to bamboo/install (one level up from libfranka)
run_quiet "libfranka: cmake configure" $CMAKE_CMD .. -DCMAKE_INSTALL_PREFIX="$SCRIPT_DIR/install" -DBUILD_TESTS=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=/opt/openrobots/lib/cmake
run_quiet "libfranka: build" make -j$(nproc)
run_quiet "libfranka: install" make install

# Get absolute path of the install directory
INSTALL_LIB_PATH="$SCRIPT_DIR/install/lib"

echo "Libraries installed to: $INSTALL_LIB_PATH"

# Add to bashrc if not already present
if ! grep -q "$INSTALL_LIB_PATH" "$HOME/.bashrc"; then
    echo "" >> "$HOME/.bashrc"
    echo "# Added by libfranka InstallPackage script" >> "$HOME/.bashrc"
    echo "export LD_LIBRARY_PATH=\"$INSTALL_LIB_PATH:/opt/openrobots/lib:\$LD_LIBRARY_PATH\"" >> "$HOME/.bashrc"
    echo "Added LD_LIBRARY_PATH to ~/.bashrc"
fi

# Export for current session
export LD_LIBRARY_PATH="$INSTALL_LIB_PATH:/opt/openrobots/lib:$LD_LIBRARY_PATH"

# download protobuf
cd "$SCRIPT_DIR/third_party"
run_quiet "protobuf: git clone" git clone --recursive https://github.com/protocolbuffers/protobuf.git
cd protobuf
run_quiet "protobuf: git checkout v27.0" git checkout v27.0
run_quiet "protobuf: git submodule update" git submodule update --init --recursive

# Use cmake instead of bazel to avoid compiler issues
mkdir -p build
cd build
run_quiet "protobuf: cmake configure" $CMAKE_CMD .. -DCMAKE_INSTALL_PREFIX="$SCRIPT_DIR/install" -Dprotobuf_BUILD_TESTS=OFF
run_quiet "protobuf: build" make -j$(nproc)
run_quiet "protobuf: install" make install

# Clone and build gRPC
cd "$SCRIPT_DIR/third_party"
run_quiet "grpc: git clone" git clone --recurse-submodules -b v1.64.0 --depth 1 --shallow-submodules https://github.com/grpc/grpc
cd grpc
mkdir build
cd build
# Use -O1 optimization to avoid gcc-9 internal compiler error in call.cc
run_quiet "grpc: cmake configure" $CMAKE_CMD -DgRPC_INSTALL=ON -DgRPC_BUILD_TESTS=OFF -DCMAKE_INSTALL_PREFIX="$SCRIPT_DIR/install" -DCMAKE_CXX_FLAGS="-O1" ..
run_quiet "grpc: build" make -j$(nproc)
run_quiet "grpc: install" make install

