#!/bin/bash

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Helper function to run build commands quietly
# Shows only errors unless the command fails
run_quiet() {
    local step_name="$1"
    shift
    local log_file=$(mktemp)

    echo "[$step_name]..."
    if "$@" > "$log_file" 2>&1; then
        echo "[$step_name] ✓"
        rm "$log_file"
        return 0
    else
        echo "[$step_name] ✗ FAILED - Output:"
        echo "----------------------------------------"
        cat "$log_file"
        echo "----------------------------------------"
        rm "$log_file"
        return 1
    fi
}

# Clone libfranka to third_party
cd "$SCRIPT_DIR"
mkdir -p third_party
cd third_party
run_quiet "libfranka: git clone" git clone --recurse-submodules https://github.com/frankaemika/libfranka
cd libfranka

echo "Which libfranka version are you going to use? (tested on 0.14.0, but 0.13.0 should work as well)"
read version

run_quiet "libfranka: git checkout ${version}" git checkout ${version}
run_quiet "libfranka: git submodule update" git submodule update

mkdir -p build
cd build

# Install to bamboo/install (one level up from libfranka)
run_quiet "libfranka: cmake configure" cmake .. -DCMAKE_INSTALL_PREFIX="$SCRIPT_DIR/install" -DBUILD_TESTS=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=/opt/openrobots/lib/cmake
run_quiet "libfranka: build" make -j$(nproc)
run_quiet "libfranka: install" make install

# Get absolute path of the install directory
INSTALL_LIB_PATH="$SCRIPT_DIR/install/lib"

echo "Libraries installed to: $INSTALL_LIB_PATH"

